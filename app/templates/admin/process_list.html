{% extends "admin/base.html" %}
{% from "components/ui_components.html" import empty_state, spinner %}

{% block title %}Processos - Admin SS-54{% endblock %}

{% block content %}
<div>
    <!-- Flash Messages -->
    {% if request.query_params.get('success') %}
    <div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4 flex items-center gap-3">
        <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <p class="text-green-800 text-sm">{{ request.query_params.get('success') }}</p>
    </div>
    {% endif %}

    {% if request.query_params.get('error') %}
    <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-3">
        <svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <p class="text-red-800 text-sm">{{ request.query_params.get('error') }}</p>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-start justify-between">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Processos</h1>
                <p class="text-slate-600 mt-1">Gerenciar todos os processos</p>
            </div>
            <div id="selection-bar" class="hidden text-sm text-blue-600">
                <span class="font-medium"><span id="selection-count">0</span> selecionado(s)</span>
                <button type="button" id="clear-selection" class="ml-2 text-blue-500 hover:text-blue-700 underline">
                    Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <form method="GET" class="flex flex-wrap gap-4">
            <!-- Search -->
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-slate-700 mb-1">Buscar</label>
                <input type="text" name="search" value="{{ search or '' }}" placeholder="Protocolo, email ou nome..."
                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Status Filter -->
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                <select name="status" data-auto-submit
                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todos</option>
                    {% for s in statuses %}
                    <option value="{{ s }}" {% if current_status==s %}selected{% endif %}>
                        {{ status_info[s]['label'] }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Clear Button -->
            <div class="flex items-end">
                <a href="/admin/processes"
                    class="px-4 py-2.5 border border-slate-300 rounded-lg font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                    Limpar
                </a>
            </div>
        </form>
    </div>

    <!-- Process Table -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        {% if processes %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-200">
                        <th class="px-4 py-4 w-12" onclick="event.stopPropagation()">
                            <input type="checkbox" id="select-all"
                                class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Protocolo</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Paciente</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tipo
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Status</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Documentos</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Criado</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            Alterado</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for process in processes %}
                    <tr class="hover:bg-slate-50 cursor-pointer process-row" data-process-id="{{ process.id }}"
                        data-status="{{ process.status }}">
                        <td class="px-4 py-3 w-12" onclick="event.stopPropagation()">
                            <input type="checkbox" data-process-checkbox
                                class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                        </td>
                        <td class="px-6 py-3 text-sm font-mono font-medium">
                            <a href="/admin/processes/{{ process.id }}" class="text-blue-600 hover:underline"
                                onclick="event.stopPropagation()">
                                {{ process.protocol_number }}
                            </a>
                        </td>
                        <td class="px-6 py-3">
                            <div class="text-sm font-medium text-slate-900">
                                <a href="/admin/processes/{{ process.id }}" class="hover:text-blue-600 hover:underline"
                                    onclick="event.stopPropagation()">
                                    {{ process.patient.name or common_labels.not_informed }}
                                </a>
                            </div>
                            <div class="text-xs text-slate-500">{{ process.patient.email or common_labels.not_informed
                                }}</div>
                        </td>
                        <td class="px-6 py-3 text-sm text-slate-600">
                            {{ type_labels.get(process.type, process.type) }}
                        </td>
                        <td class="px-6 py-3">
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-{{ status_info[process.status]['color'] }}-100 text-{{ status_info[process.status]['color'] }}-800">
                                {{ status_info[process.status]['label'] }}
                            </span>
                        </td>
                        <td class="px-6 py-3 text-sm text-slate-600">
                            {{ process.document_count }} arquivo(s)
                        </td>
                        <td class="px-6 py-3 text-sm text-slate-500">
                            {{ process.created_at|date("%d/%m/%Y") }}
                        </td>
                        <td class="px-6 py-3 text-sm text-slate-500">
                            {{ process.updated_at|date("%d/%m/%Y") }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="py-8">
            {% if search or current_status %}
            {{ empty_state(common_labels.try_adjust_filters, padding="py-4") }}
            {% else %}
            {{ empty_state(common_labels.no_process_found, padding="py-4") }}
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if total > 0 %}
    <div class="mt-6 flex items-center justify-between">
        <!-- Results info -->
        <div class="text-sm text-slate-500">
            Mostrando {{ (page - 1) * per_page + 1 }}-{{ [page * per_page, total]|min }} de {{ total }} processo(s)
        </div>

        {% if total_pages > 1 %}
        <!-- Pagination controls -->
        <div class="flex items-center gap-1">
            <!-- Previous button -->
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
                class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100">
                ← Anterior
            </a>
            {% else %}
            <span class="px-3 py-2 rounded-lg text-sm font-medium text-slate-300 cursor-not-allowed">
                ← Anterior
            </span>
            {% endif %}

            <!-- Page numbers -->
            <div class="flex items-center gap-1 mx-2">
                {% set start_page = [1, page - 2]|max %}
                {% set end_page = [total_pages, page + 2]|min %}

                {% if start_page > 1 %}
                <a href="?page=1{% if current_status %}&status={{ current_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
                    class="w-10 h-10 flex items-center justify-center rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100">
                    1
                </a>
                {% if start_page > 2 %}
                <span class="px-2 text-slate-400">...</span>
                {% endif %}
                {% endif %}

                {% for p in range(start_page, end_page + 1) %}
                {% if p == page %}
                <span
                    class="w-10 h-10 flex items-center justify-center rounded-lg text-sm font-medium bg-blue-600 text-white">
                    {{ p }}
                </span>
                {% else %}
                <a href="?page={{ p }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
                    class="w-10 h-10 flex items-center justify-center rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100">
                    {{ p }}
                </a>
                {% endif %}
                {% endfor %}

                {% if end_page < total_pages %} {% if end_page < total_pages - 1 %} <span class="px-2 text-slate-400">
                    ...</span>
                    {% endif %}
                    <a href="?page={{ total_pages }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
                        class="w-10 h-10 flex items-center justify-center rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100">
                        {{ total_pages }}
                    </a>
                    {% endif %}
            </div>

            <!-- Next button -->
            {% if page < total_pages %} <a
                href="?page={{ page + 1 }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
                class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100">
                Próximo →
                </a>
                {% else %}
                <span class="px-3 py-2 rounded-lg text-sm font-medium text-slate-300 cursor-not-allowed">
                    Próximo →
                </span>
                {% endif %}
        </div>
        {% else %}
        <div></div>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Context Menu -->
<div id="context-menu"
    class="hidden fixed bg-white rounded-lg shadow-lg border border-slate-200 py-2 min-w-[200px] z-50">
    <div class="px-3 py-2 text-xs font-medium text-slate-500 uppercase tracking-wider border-b border-slate-100">
        Alterar Status
    </div>
    {% for status_key, status_data in status_info.items() %}
    <button type="button" data-context-action="change-status" data-status="{{ status_key }}"
        class="w-full px-3 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-3 transition-colors">
        <span class="w-3 h-3 rounded-full bg-{{ status_data.color }}-400 flex-shrink-0"></span>
        <span>{{ status_data.label }}</span>
    </button>
    {% endfor %}
</div>

<script src="/static/js/admin-processes.js" defer></script>
{% endblock %}